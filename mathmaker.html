<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学题生成器</title>
    <style>
        body {
            display: flex;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            height: 100vh;
        }

        #main-column {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            /*border-right: 1px solid #ccc;*/
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .a4-page {
            width: 210mm;
            height: 297mm;
            margin: 20px auto;
            padding: 15mm 20mm 15mm 20mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            position: relative;
        }
        
        .page-header {
            width: 100%;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10mm;
            padding-bottom: 5mm;
            border-bottom: 1px solid #ddd;
        }
        
        .page-footer {
            width: 100%;
            text-align: center;
            font-size: 12px;
            margin-top: 5mm;
            padding-top: 3mm;
            border-top: 1px solid #ddd;
            position: absolute;
            bottom: 10mm;
            left: 0;
            right: 0;
        }

        .a4-page table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .a4-page td {
            width: 33.33%;
            height: 8mm;
            text-align: center;
            vertical-align: middle;
            padding: 2px;
            box-sizing: border-box;
        }

        .a4-page .problem {
            font-size: 16px;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            min-height: 25px;
            overflow: hidden;
            white-space: nowrap;
        }

        #sidebar {
            width: 400px;
            padding: 20px;
            box-sizing: border-box;
            background-color: #e9e9e9;
            order: 2;
        }

        .form-group {
            margin-bottom: 15px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.1);
            min-height: fit-content;
            overflow: visible;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        button {
            margin-bottom: 10px;
            padding: 8px 15px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        select,
        input {
            padding: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 20%;
            box-sizing: border-box;
        }

        /* 运算符号选择框特殊样式 */
        .equation select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #fff;
            background-image: none;
            width: 40px;
            min-width: 40px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            padding: 3px;
            margin: 0 3px;
            border: 1px solid #007bff;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
        }

        .equation select:focus {
            border-color: #0056b3;
            box-shadow: 0 0 3px rgba(0, 123, 255, 0.3);
        }

        .equation select:hover {
            background-color: #f8f9fa;
        }

        .equation {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            min-height: 40px;
        }

        .equation span {
            color: red;
            font-weight: bold;
        }

        .paper-button {
            background-color: #28a745;
        }

        .paper-button:hover {
            background-color: #218838;
        }

        .create-button {
            background-color: #f99f00;
        }

        .create-button:hover {
            background-color: #dc9009;
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-container button {
            margin-bottom: 0;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            #sidebar {
                display: none;
            }
            #main-column {
                width: 100%;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0;
            }
            .a4-page {
                page-break-after: always;
                margin: 0;
                box-shadow: none;
                width: 210mm;
                height: 297mm;
                padding: 15mm 20mm 15mm 20mm;
            }
            .page-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .page-footer {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>

<body>
    <div id="main-column">
        <!-- 题目预览区域 -->
    </div>
    <div id="sidebar">
<h2>数学题自动生成器</h2>
        <button id="export-button">导出</button>
        <button id="print-button">打印</button>
<hr>
<h3>设置题型</h3>
        <div id="settings-container"></div>
        <div class="button-container">
            <button id="add-type-button">+ 新增题型</button>
            <button id="generate-button" class="create-button" >√ 点击生成</button>
        </div>
<hr> 
<h3>历史题库</h3>  
     <div id="paper-list">
            <button class="paper-button" data-index="0">卷子1</button>
            <button class="paper-button" data-index="1">卷子2</button>
            <button class="paper-button" data-index="2">卷子3</button>
        </div>
    </div>
    <script>
        const mainColumn = document.getElementById('main-column');
        const settingsContainer = document.getElementById('settings-container');
        const addTypeButton = document.getElementById('add-type-button');
        const generateButton = document.getElementById('generate-button');
        const exportButton = document.getElementById('export-button');
        const printButton = document.getElementById('print-button');
        const paperList = document.getElementById('paper-list');
        let settingsForms = [];
        let storedData = JSON.parse(localStorage.getItem('mathProblems')) || [];

        const emptySquareSVG = '<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"  viewBox="0 0 24 24"><rect width="22" height="22" fill="none" stroke="#ddd" stroke-width="1"/></svg>';

        addTypeButton.addEventListener('click', () => {
            const form = document.createElement('div');
            form.classList.add('form-group');

            const termCountLabel = document.createElement('span');
            termCountLabel.textContent = '项数：';
            const termCountSelect = document.createElement('select');
            termCountSelect.title = '设置题目中的项数，可选择2 - 6项';
            for (let i = 2; i <= 6; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                termCountSelect.appendChild(option);
            }
            termCountSelect.addEventListener('change', updateForm);
            const termCountDiv = document.createElement('div');
            termCountDiv.appendChild(termCountLabel);
            termCountDiv.appendChild(termCountSelect);
            form.appendChild(termCountDiv);

            const equationDiv = document.createElement('div');
            equationDiv.classList.add('equation');
            const equationLabel = document.createElement('span');
            equationLabel.textContent = '题型: ';
            equationDiv.appendChild(equationLabel);
            form.appendChild(equationDiv);

            const unknownLabel = document.createElement('span');
            unknownLabel.textContent = '未知数：';
            const unknownSelect = document.createElement('select');
            unknownSelect.title = '选择题目中的未知数';
            const unknownDiv = document.createElement('div');
            unknownDiv.appendChild(unknownLabel);
            unknownDiv.appendChild(unknownSelect);
            form.appendChild(unknownDiv);

            const problemCountLabel = document.createElement('span');
            problemCountLabel.textContent = '题目数量：';
            const problemCountInput = document.createElement('input');
            problemCountInput.type = 'number';
            problemCountInput.min = 1;
            problemCountInput.max = 100;
            problemCountInput.value = 1;
            problemCountInput.title = '设置生成题目的数量，范围为1 - 100';
            const problemCountDiv = document.createElement('div');
            problemCountDiv.appendChild(problemCountLabel);
            problemCountDiv.appendChild(problemCountInput);
            form.appendChild(problemCountDiv);

            const difficultyLabel = document.createElement('span');
            difficultyLabel.textContent = '难度：';
            const difficultySelect = document.createElement('select');
            difficultySelect.title = '设置题目中数字的难度范围';
            const difficulties = ['10以内整数', '20以内整数', '50以内整数', '100以内整数'];
            difficulties.forEach(difficulty => {
                const option = document.createElement('option');
                option.value = difficulty;
                option.textContent = difficulty;
                difficultySelect.appendChild(option);
            });
            const difficultyDiv = document.createElement('div');
            difficultyDiv.appendChild(difficultyLabel);
            difficultyDiv.appendChild(difficultySelect);
            form.appendChild(difficultyDiv);

            settingsContainer.appendChild(form);
            settingsForms.push(form);
            updateForm({ target: termCountSelect });
        });

        function updateForm(event) {
            const form = event.target.parentNode.parentNode;
            const termCount = parseInt(event.target.value);
            const equationDiv = form.children[1];
            const unknownSelect = form.children[2].children[1];
            equationDiv.innerHTML = '<span>题型: </span>';
            unknownSelect.innerHTML = '';

            for (let i = 0; i < termCount; i++) {
                const span = document.createElement('span');
                span.textContent = `A${i + 1}`;
                equationDiv.appendChild(span);
                if (i < termCount - 1) {
                    const operatorSelect = document.createElement('select');
                    operatorSelect.title = '选择运算符号';
                    const operators = ['+', '-', '*', '÷'];
                    operators.forEach(operator => {
                        const option = document.createElement('option');
                        option.value = operator;
                        option.textContent = operator;
                        operatorSelect.appendChild(option);
                    });
                    equationDiv.appendChild(operatorSelect);
                }
            }
            const equalSign = document.createElement('span');
            equalSign.textContent = '=';
            equationDiv.appendChild(equalSign);
            const resultSpan = document.createElement('span');
            resultSpan.textContent = 'D';
            equationDiv.appendChild(resultSpan);

            for (let i = 0; i < termCount; i++) {
                const option = document.createElement('option');
                option.value = `A${i + 1}`;
                option.textContent = `A${i + 1}`;
                unknownSelect.appendChild(option);
            }
            const resultOption = document.createElement('option');
            resultOption.value = 'D';
            resultOption.textContent = 'D';
            unknownSelect.appendChild(resultOption);
        }

        generateButton.addEventListener('click', () => {
            mainColumn.innerHTML = '';
            let allProblems = [];
            settingsForms.forEach(form => {
                const termCount = parseInt(form.children[0].children[1].value);
                const operators = [];
                for (let i = 1; i < termCount; i++) {
                    operators.push(form.children[1].children[i * 2].value);
                }
                const unknown = form.children[2].children[1].value;
                const problemCount = parseInt(form.children[3].children[1].value);
                const difficulty = form.children[4].children[1].value;
                const maxNumber = parseInt(difficulty.split('以内整数')[0]);

                for (let i = 0; i < problemCount; i++) {
                    let numbers = [];
                    for (let j = 0; j < termCount; j++) {
                        numbers.push(Math.floor(Math.random() * maxNumber) + 1);
                    }
                    let result = numbers[0];
                    let hasNegative = false;
                    for (let j = 1; j < termCount; j++) {
                        switch (operators[j - 1]) {
                            case '+':
                                result += numbers[j];
                                break;
                            case '-':
                                if (numbers[j - 1] < numbers[j]) {
                                    hasNegative = true;
                                    break;
                                }
                                result -= numbers[j];
                                break;
                            case '*':
                                result *= numbers[j];
                                break;
                            case '÷':
                                if (numbers[j - 1] % numbers[j]!== 0) {
                                    hasNegative = true;
                                    break;
                                }
                                result /= numbers[j];
                                break;
                        }
                        if (hasNegative) break;
                    }
                    if (hasNegative || result < 1) continue;

                    let equation = '';
                    for (let j = 0; j < termCount; j++) {
                        if (unknown === `A${j + 1}`) {
                            equation += emptySquareSVG;
                        } else {
                            equation += numbers[j];
                        }
                        if (j < termCount - 1) {
                            let operator = operators[j];
                            if (operator === '*') {
                                operator = 'x';
                            }
                            equation += operator;
                        }
                    }
                    if (unknown === 'D') {
                        equation += `=${emptySquareSVG}`;
                    } else {
                        equation += `=${result}`;
                    }
                    allProblems.push(equation);
                }
            });

            showProblems(allProblems);

            storedData.unshift(allProblems);
            if (storedData.length > 3) {
                storedData.pop();
            }
            localStorage.setItem('mathProblems', JSON.stringify(storedData));
        });

        function showProblems(problems) {
            mainColumn.innerHTML = '';
            
            const problemsPerPage = 75; // 25行 × 3列
            const rowsPerPage = 25;
            const colsPerRow = 3;
            
            // 计算需要的页面数量
            const totalPages = Math.ceil(problems.length / problemsPerPage);
            
            for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                // 创建新的A4页面
                const page = document.createElement('div');
                page.classList.add('a4-page');
                
                // 计算当前页面的题目数量
                const startIndex = pageNum * problemsPerPage;
                const endIndex = Math.min(startIndex + problemsPerPage, problems.length);
                const currentPageProblems = endIndex - startIndex;
                
                // 添加页眉
                const header = document.createElement('div');
                header.classList.add('page-header');
                header.innerHTML = `计算题练习&nbsp;&nbsp;&nbsp;&nbsp;用时______&nbsp;&nbsp;&nbsp;&nbsp;得分______&nbsp;&nbsp;&nbsp;&nbsp;（答对______题/${currentPageProblems}题）`;
                page.appendChild(header);
                
                // 创建表格容器
                const tableContainer = document.createElement('div');
                tableContainer.style.flex = '1';
                tableContainer.style.width = '100%';
                tableContainer.style.display = 'flex';
                tableContainer.style.alignItems = 'center';
                tableContainer.style.justifyContent = 'center';
                
                const table = document.createElement('table');
                tableContainer.appendChild(table);
                page.appendChild(tableContainer);
                
                // 添加页码
                const footer = document.createElement('div');
                footer.classList.add('page-footer');
                
                footer.textContent = `题目数量：${currentPageProblems}题    第${pageNum + 1}页`;
                page.appendChild(footer);
                
                mainColumn.appendChild(page);
                
                // 填充当前页面的题目
                for (let row = 0; row < rowsPerPage; row++) {
                    const tr = document.createElement('tr');
                    
                    for (let col = 0; col < colsPerRow; col++) {
                        const td = document.createElement('td');
                        const currentProblemIndex = pageNum * problemsPerPage + row * colsPerRow + col;
                        
                        if (currentProblemIndex < problems.length) {
                            const problemDiv = document.createElement('div');
                            problemDiv.classList.add('problem');
                            problemDiv.innerHTML = problems[currentProblemIndex];
                            
                            // 字体自适应功能
                            setTimeout(() => {
                                adjustFontSize(problemDiv, td);
                            }, 10);
                            
                            td.appendChild(problemDiv);
                        }
                        
                        tr.appendChild(td);
                    }
                    
                    table.appendChild(tr);
                }
            }
        }
        
        function adjustFontSize(problemDiv, container) {
            let fontSize = 16;
            problemDiv.style.fontSize = fontSize + 'px';
            
            while (problemDiv.scrollWidth > container.clientWidth && fontSize > 8) {
                fontSize -= 0.5;
                problemDiv.style.fontSize = fontSize + 'px';
            }
        }

        paperList.addEventListener('click', (event) => {
            if (event.target.classList.contains('paper-button')) {
                const index = parseInt(event.target.dataset.index);
                if (storedData[index]) {
                    showProblems(storedData[index]);
                }
            }
        });

        exportButton.addEventListener('click', async () => {
            const doc = new jspdf.jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });
            const pages = mainColumn.querySelectorAll('.a4-page');
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const canvas = await html2canvas(page);
                const imgData = canvas.toDataURL('image/png');
                if (i > 0) {
                    doc.addPage();
                }
                doc.addImage(imgData, 'PNG', 0, 0, 210, 297);
            }
            doc.save('math_problems.pdf');
        });

        printButton.addEventListener('click', () => {
            window.print();
        });
    </script>
</body>

</html>
    