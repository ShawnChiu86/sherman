<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAZ备考计划跟踪系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --sidebar-bg: #f8f9fa;
            --border-color: #dee2e6;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            width: 100%;
            
            margin: 0 auto;
            box-shadow: var(--shadow);
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        /* 左侧导航样式 */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .stage-nav {
            list-style: none;
        }
        
        .stage-nav li {
            margin-bottom: 5px;
        }
        
        .stage-nav a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--dark-color);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .stage-nav a:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .stage-nav a.active {
            background-color: rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .stage-nav i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* 右侧内容样式 */
        .content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .content-header h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .stats {
            display: flex;
            gap: 15px;
        }
        
        .stat-item {
            background-color: var(--light-color);
            padding: 10px 15px;
            border-radius: 5px;
            text-align: center;
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* 表格样式 */
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: visible;
            box-shadow: var(--shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            overflow: visible;
        }
        
        thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            overflow: visible;
        }
        
        th {
            font-weight: 600;
        }
        
        tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        /* 表格内编辑控件样式 */
        .progress-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* 状态标签选择器样式 */
        .status-selector {
            position: relative;
            width: 100%;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            color: white !important;
            text-align: center;
            min-width: 70px;
            position: relative;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .status-badge.active {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8), 0 0 0 4px rgba(67, 97, 238, 0.3);
        }

        /* 不同状态的标签颜色 */
        .status-badge.status-not-started {
            background-color: #6c757d;
            color: white !important;
        }

        .status-badge.status-not-started:hover {
            background-color: #5a6268;
            color: white !important;
        }

        .status-badge.status-in-progress {
            background-color: #4361ee;
            color: white !important;
        }

        .status-badge.status-in-progress:hover {
            background-color: #3651d4;
            color: white !important;
        }

        .status-badge.status-completed {
            background-color: #28a745;
            color: white !important;
        }

        .status-badge.status-completed:hover {
            background-color: #218838;
            color: white !important;
        }

        .status-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 99999;
            display: none;
            min-width: 120px;
            overflow: hidden;
        }

        .status-options.show {
            display: block;
            animation: fadeInUp 0.2s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status-option {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
            color: white !important;
            border: none;
            width: 100%;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .status-option:hover {
            opacity: 0.9;
        }

        .status-option.status-not-started {
            background-color: #6c757d;
            color: white !important;
        }

        .status-option.status-in-progress {
            background-color: #4361ee;
            color: white !important;
        }

        .status-option.status-completed {
            background-color: #28a745;
            color: white !important;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-bar {
            width: 80px;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .progress-bar:hover {
            background-color: #dee2e6;
            transform: scale(1.02);
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            min-width: 35px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            color: #495057;
        }
        
        /* 弹窗输入框样式 */
        /* 进度条直接编辑样式 */
        .progress-container.editing {
            background-color: #fff3cd;
            border-radius: 4px;
            padding: 4px;
        }

        .progress-edit-input {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid #4361ee;
            border-radius: 3px;
            font-size: 0.85rem;
            text-align: center;
            background-color: white;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .progress-edit-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        .time-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        /* 展开/收起行的样式 */
        .expandable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .expandable-row:hover {
            background-color: #f8f9fa;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.2s ease;
            font-size: 12px;
            color: #6c757d;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .detail-row {
            display: none;
            background-color: #f8f9fa;
            border-left: 4px solid #4361ee;
        }

        .detail-row.show {
            display: table-row;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .detail-content {
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .detail-section {
            margin-bottom: 15px;
            position: relative;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .detail-text {
            color: #6c757d;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .detail-text:empty::after {
            content: "暂无内容";
            color: #adb5bd;
            font-style: italic;
        }

        /* 编辑功能样式 */
        .edit-icon {
            cursor: pointer;
            color: #6c757d;
            font-size: 14px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .edit-icon:hover {
            color: #4361ee;
            background-color: #f8f9fa;
        }

        .edit-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            font-family: inherit;
        }

        .edit-textarea:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .edit-buttons {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn.save {
            background-color: #28a745;
            color: white;
        }

        .edit-btn.save:hover {
            background-color: #218838;
        }

        .edit-btn.cancel {
            background-color: #6c757d;
            color: white;
        }

        .edit-btn.cancel:hover {
            background-color: #5a6268;
        }

        /* 任务详情列编辑样式 */
        .task-detail-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .task-detail-cell:hover {
            background-color: #f8f9fa;
        }

        .task-detail-cell.editing {
            background-color: #fff3cd;
            cursor: default;
        }

        .task-detail-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #4361ee;
            border-radius: 4px;
            font-size: 0.9rem;
            line-height: 1.4;
            font-family: inherit;
            background-color: white;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .task-detail-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        .task-detail-buttons {
            margin-top: 6px;
            display: flex;
            gap: 6px;
        }

        .task-detail-btn {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-detail-btn.save {
            background-color: #28a745;
            color: white;
        }

        .task-detail-btn.save:hover {
            background-color: #218838;
        }

        .task-detail-btn.cancel {
            background-color: #6c757d;
            color: white;
        }

        .task-detail-btn.cancel:hover {
            background-color: #5a6268;
        }

        /* 响应式设计 */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .stage-nav {
                display: flex;
                overflow-x: auto;
            }
            
            .stage-nav li {
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .stage-nav a {
                white-space: nowrap;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            
            .stage-nav a.active {
                border-left: none;
                border-bottom-color: var(--primary-color);
            }
        }
        
        @media (max-width: 768px) {
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 800px;
            }
        }
        
        /* 保存通知 */
        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        
        .save-notification.show {
            opacity: 1;
        }
        
        /* 状态颜色 */
        .status-not-started {
            color: #6c757d;
        }
        
        .status-in-progress {
            color: var(--primary-color);
        }
        
        .status-completed {
            color: #28a745;
        }
    </style>
</head>
<body>
    <!-- 进度编辑弹窗 -->


    <div class="container">
        <!-- 左侧导航 -->
        <div class="sidebar">
            <div class="logo">
                <h1>RAZ备考计划</h1>
                <p>跟踪和管理备考进度</p>
            </div>
            <ul class="stage-nav" id="stage-nav">
                <!-- 导航将通过JavaScript动态生成 -->
            </ul>
        </div>
        
        <!-- 右侧内容 -->
        <div class="content">
            <div class="content-header">
                <h2 id="current-stage">识字阶段</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-tasks">0</div>
                        <div class="stat-label">总任务数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completed-tasks">0</div>
                        <div class="stat-label">已完成</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="progress-percent">0%</div>
                        <div class="stat-label">总进度</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-duration">0</div>
                        <div class="stat-label">完成天数</div>
                    </div>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>任务名称</th>
                            <th>任务详情</th>
                            <th>RAZ等级</th>
                            <th>状态</th>
                            <th>进度</th>
                            <th>创建时间</th>
                            <th>计划完成时间</th>
                            <th>完成/总计(天)</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-table-body">
                        <!-- 表格内容将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="save-notification" id="save-notification">
        <i class="fas fa-check-circle"></i> 数据已保存！
    </div>

    <script>
        // 初始数据（从Excel表格中提取）
        const initialData = [
            {
                stage: "识字阶段",
                taskName: "阶段一",
                taskDetail: "AA-A ABC-READING开启",
                razLevel: "AA-A（25天）",
                note: "这一阶段以培养兴趣为主，从缓都快的一个过程-一定要指读-必要时倒着读",
                materials: "开始一些中文识字、阅读",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "识字阶段",
                taskName: "阶段二",
                taskDetail: "给充足的时间给英语",
                razLevel: "B-D（25天）",
                note: "这一阶段，保证坚持每天10本，同时保证质量，打分不能过于低。要确保指读和抽查倒读",
                materials: "中文科普快速介入、并看一些科普视频、理科类，以兴趣为主",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "识字阶段",
                taskName: "阶段三",
                taskDetail: "逐步变得流利起来",
                razLevel: "E-F（20天）",
                note: "这一阶段，坚持，同时间任务变得复杂。需要开始过单词",
                materials: "1、过单词 2、1000词开始动手写",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "阅读书写阶段",
                taskName: "阶段四",
                taskDetail: "开始挑战自我",
                razLevel: "G-H（20天）",
                note: "从这一刻起，你开始想相信坚持的意义。但是记住，别糊弄。",
                materials: "1、搭配fly guy、dog man验证独立阅读能力 2、不需要沉迷桥梁、初章、仅仅验证用。",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "阅读书写阶段",
                taskName: "阶段五",
                taskDetail: "开始准备着手写",
                razLevel: "I-J(20天）",
                note: "",
                materials: "1、write right的切入，开始一些句子、短文的书写。 2、开始新东方单词过1000-2000词",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "应试准备阶段",
                taskName: "阶段六",
                taskDetail: "正式报名KET",
                razLevel: "KL(40天)",
                note: "1、会卡认知，会卡速度。解决方案，加量。",
                materials: "1、打印KET真题 ，并做 2、听力的介入 3、Quiz的介入",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "应试准备阶段",
                taskName: "阶段七",
                taskDetail: "精读、听力、口语",
                razLevel: "MN(45天）",
                note: "1、根据真题，查看孩子的薄弱环节，跟姐答案，查漏补缺。（留2套）",
                materials: "1、可以开始RE朗读。不做其他要求。 2、外教练习，模拟口语。 3、听力训练。",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "应试准备阶段",
                taskName: "OPQ阶段",
                taskDetail: "",
                razLevel: "OPQ（2个月）",
                note: "1、听力训练 2、结合write right 作文训练。 3、外教口语训练",
                materials: "",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "应试准备阶段",
                taskName: "RS阶段",
                taskDetail: "",
                razLevel: "RS（45天）",
                note: "1、放缓RAZ阅读。 2、加入RE朗读。 3、扣真题细节，从会读到会理解。",
                materials: "",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "备考阶段",
                taskName: "冲刺U",
                taskDetail: "真题训练",
                razLevel: "U（一个月）",
                note: "1、做PET真题，看差距，拓展词汇，训练逻辑",
                materials: "",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "备考阶段",
                taskName: "冲刺V",
                taskDetail: "真题训练 考场模拟",
                razLevel: "V（一个月）",
                note: "2、最后一个月，前面留的2套，找一个时间，再现考场情景，",
                materials: "",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            },
            {
                stage: "考试阶段",
                taskName: "KET考试",
                taskDetail: "",
                razLevel: "3天",
                note: "",
                materials: "",
                status: "未开始",
                progress: 0,
                createTime: "",
                planFinishTime: "",
                duration: 0
            }
        ];

        // 从localStorage加载数据，如果没有则使用初始数据
        let taskData = JSON.parse(localStorage.getItem('razPrepData')) || initialData;
        let currentStage = '全部阶段';

        // 保存数据到localStorage
        function saveData() {
            localStorage.setItem('razPrepData', JSON.stringify(taskData));
            updateStats();
            showSaveNotification();
        }

        // 显示保存成功的通知
        function showSaveNotification() {
            const notification = document.getElementById('save-notification');
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // 更新统计数据
        function updateStats() {
            // 如果是"全部阶段"则统计所有任务，否则只统计当前阶段的任务
            const stageTasks = currentStage === '全部阶段' ? taskData : taskData.filter(task => task.stage === currentStage);
            const totalTasks = stageTasks.length;
            const completedTasks = stageTasks.filter(task => task.status === '已完成').length;
            const totalProgress = stageTasks.reduce((sum, task) => sum + task.progress, 0) / totalTasks || 0;
            
            // 计算累计天数 - 完成天数/总计天数
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            let totalCompletedDays = 0;
            let totalPlannedDays = 0;
            
            stageTasks.forEach(task => {
                if (!task.createTime) return;
                
                // 计算完成天数
                let completedDays = 0;
                if (task.status === '已完成' && task.planFinishTime) {
                    // 如果状态为已完成，完成天数为创建时间到计划完成时间的天数
                    completedDays = calculateDaysDifference(task.createTime, task.planFinishTime);
                } else {
                    // 否则为创建时间到今天的天数
                    completedDays = calculateDaysDifference(task.createTime, todayStr);
                }
                
                // 计算总计天数（从创建时间到计划完成时间）
                let plannedDays = 0;
                if (task.planFinishTime) {
                    plannedDays = calculateDaysDifference(task.createTime, task.planFinishTime);
                }
                
                totalCompletedDays += Math.max(0, completedDays);
                totalPlannedDays += Math.max(0, plannedDays);
            });
            
            const totalDuration = `${totalCompletedDays}/${totalPlannedDays}`;
            
            document.getElementById('total-tasks').textContent = totalTasks;
            document.getElementById('completed-tasks').textContent = completedTasks;
            document.getElementById('progress-percent').textContent = `${Math.round(totalProgress)}%`;
            document.getElementById('total-duration').textContent = totalDuration;
        }

        // 渲染左侧导航
        function renderStageNav() {
            const stageNav = document.getElementById('stage-nav');
            stageNav.innerHTML = '';
            
            // 首先添加"全部阶段"菜单项
            const allStagesLi = document.createElement('li');
            const allStagesA = document.createElement('a');
            allStagesA.href = '#';
            allStagesA.innerHTML = `<i class="fas fa-list"></i> 全部阶段`;
            
            if (currentStage === '全部阶段') {
                allStagesA.classList.add('active');
            }
            
            allStagesA.addEventListener('click', function(e) {
                e.preventDefault();
                currentStage = '全部阶段';
                document.getElementById('current-stage').textContent = '全部阶段';
                
                // 更新导航激活状态
                document.querySelectorAll('.stage-nav a').forEach(link => {
                    link.classList.remove('active');
                });
                this.classList.add('active');
                
                // 渲染表格
                renderTasksTable();
                updateStats();
            });
            
            allStagesLi.appendChild(allStagesA);
            stageNav.appendChild(allStagesLi);
            
            // 获取所有阶段
            const stages = [...new Set(taskData.map(task => task.stage))];
            
            // 为每个阶段创建导航项
            stages.forEach(stage => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#';
                a.innerHTML = `<i class="fas fa-${getStageIcon(stage)}"></i> ${stage}`;
                
                if (stage === currentStage) {
                    a.classList.add('active');
                }
                
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentStage = stage;
                    document.getElementById('current-stage').textContent = stage;
                    
                    // 更新导航激活状态
                    document.querySelectorAll('.stage-nav a').forEach(link => {
                        link.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 渲染表格
                    renderTasksTable();
                    updateStats();
                });
                
                li.appendChild(a);
                stageNav.appendChild(li);
            });
        }

        // 根据阶段名称获取图标
        function getStageIcon(stage) {
            if (stage.includes('识字')) return 'book';
            if (stage.includes('阅读')) return 'pen';
            if (stage.includes('应试')) return 'graduation-cap';
            if (stage.includes('备考')) return 'running';
            if (stage.includes('考试')) return 'file-alt';
            return 'tasks';
        }

        // 根据状态获取CSS类名
        function getStatusClass(status) {
            switch(status) {
                case '未开始': return 'not-started';
                case '进行中': return 'in-progress';
                case '已完成': return 'completed';
                default: return 'not-started';
            }
        }

        // 计算天数差
        function calculateDaysDifference(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            const timeDiff = end.getTime() - start.getTime();
            return Math.ceil(timeDiff / (1000 * 3600 * 24));
        }

        // 获取完成天数/总计天数的显示文本
        function getDurationDisplay(task) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // 如果没有创建时间，显示 -/-
            if (!task.createTime) {
                return '-/-';
            }
            
            // 计算完成天数
            let completedDays = 0;
            if (task.status === '已完成' && task.planFinishTime) {
                // 如果状态为已完成，完成天数为创建时间到计划完成时间的天数
                completedDays = calculateDaysDifference(task.createTime, task.planFinishTime);
            } else {
                // 否则为创建时间到今天的天数
                completedDays = calculateDaysDifference(task.createTime, todayStr);
            }
            
            // 计算总计天数（从创建时间到计划完成时间）
            let totalDays = 0;
            if (task.planFinishTime) {
                totalDays = calculateDaysDifference(task.createTime, task.planFinishTime);
            }
            
            // 如果没有计划完成时间，只显示完成天数
            if (!task.planFinishTime) {
                return `${Math.max(0, completedDays)}/-`;
            }
            
            return `${Math.max(0, completedDays)}/${Math.max(0, totalDays)}`;
        }

        // 渲染任务表格
        function renderTasksTable() {
            const tbody = document.getElementById('tasks-table-body');
            tbody.innerHTML = '';
            
            // 过滤当前阶段的任务，如果是"全部阶段"则显示所有任务
            const stageTasks = currentStage === '全部阶段' ? taskData : taskData.filter(task => task.stage === currentStage);
            
            // 为每个任务创建表格行
            stageTasks.forEach((task, index) => {
                const taskIndex = taskData.indexOf(task);
                
                // 创建主要任务行
                const tr = document.createElement('tr');
                tr.className = 'expandable-row';
                tr.dataset.taskIndex = taskIndex;
                
                tr.innerHTML = `
                    <td><i class="fas fa-chevron-right expand-icon"></i>${task.taskName}</td>
                    <td class="task-detail-cell" data-task-index="${taskIndex}" title="点击编辑任务详情">${task.taskDetail}</td>
                    <td>${task.razLevel}</td>
                    <td>
                        <div class="status-selector" data-index="${taskIndex}">
                            <div class="status-badge status-${getStatusClass(task.status)}">${task.status}</div>
                            <div class="status-options">
                                <div class="status-option status-not-started" data-value="未开始">未开始</div>
                                <div class="status-option status-in-progress" data-value="进行中">进行中</div>
                                <div class="status-option status-completed" data-value="已完成">已完成</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="progress-container" data-index="${taskIndex}">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${task.progress}%"></div>
                            </div>
                            <div class="progress-text">${task.progress}%</div>
                        </div>
                    </td>
                    <td><input type="date" class="time-input create-time" value="${task.createTime}" data-index="${taskIndex}"></td>
                    <td><input type="date" class="time-input plan-finish-time" value="${task.planFinishTime}" data-index="${taskIndex}"></td>
                    <td>${getDurationDisplay(task)}</td>
                `;
                
                tbody.appendChild(tr);
                
                // 创建详细信息行
                const detailTr = document.createElement('tr');
                detailTr.className = 'detail-row';
                detailTr.dataset.taskIndex = taskIndex;
                
                detailTr.innerHTML = `
                    <td colspan="8">
                        <div class="detail-content">
                            <div class="detail-section" data-field="note" data-task-index="${taskIndex}">
                                <div class="detail-label">备注<i class="fas fa-edit edit-icon" title="编辑备注"></i></div>
                                <div class="detail-text">${task.note || ''}</div>
                            </div>
                            <div class="detail-section" data-field="materials" data-task-index="${taskIndex}">
                                <div class="detail-label">搭配材料<i class="fas fa-edit edit-icon" title="编辑搭配材料"></i></div>
                                <div class="detail-text">${task.materials || ''}</div>
                            </div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(detailTr);
            });
            
            // 添加事件监听器
            addEventListeners();
            addExpandListeners();
            addEditListeners();
            addTaskDetailEditListeners();
        }

        // 添加事件监听器
        function addEventListeners() {
            // 状态标签选择器事件
            document.querySelectorAll('.status-selector').forEach(statusSelector => {
                const statusBadge = statusSelector.querySelector('.status-badge');
                const statusOptions = statusSelector.querySelector('.status-options');
                const taskIndex = parseInt(statusSelector.dataset.index);

                // 点击标签显示/隐藏选项
                statusBadge.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // 关闭其他打开的下拉框
                    document.querySelectorAll('.status-badge.active').forEach(badge => {
                        if (badge !== statusBadge) {
                            badge.classList.remove('active');
                            badge.parentElement.querySelector('.status-options').classList.remove('show');
                        }
                    });
                    
                    // 切换当前下拉框
                    statusBadge.classList.toggle('active');
                    statusOptions.classList.toggle('show');
                });

                // 选择选项
                statusOptions.querySelectorAll('.status-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const statusClass = getStatusClass(value);
                        
                        // 更新标签显示文本和样式
                        statusBadge.textContent = value;
                        statusBadge.className = `status-badge status-${statusClass}`;
                        
                        // 更新数据
                        taskData[taskIndex].status = value;
                        
                        // 关闭下拉框
                        statusBadge.classList.remove('active');
                        statusOptions.classList.remove('show');
                        
                        // 保存数据
                        saveData();
                    });
                });
            });

            // 点击其他地方关闭下拉框
            document.addEventListener('click', function() {
                document.querySelectorAll('.status-badge.active').forEach(badge => {
                    badge.classList.remove('active');
                    badge.parentElement.querySelector('.status-options').classList.remove('show');
                });
            });
            
            // 进度条直接编辑事件
            let currentEditingIndex = null;
            let originalProgressHTML = '';
            
            document.addEventListener('click', function(e) {
                if (e.target.closest('.progress-container') && !e.target.closest('.progress-container').classList.contains('editing')) {
                    e.stopPropagation();
                    const progressContainer = e.target.closest('.progress-container');
                    currentEditingIndex = parseInt(progressContainer.dataset.index);
                    const currentProgress = taskData[currentEditingIndex].progress;
                    
                    // 保存原始HTML
                    originalProgressHTML = progressContainer.innerHTML;
                    
                    // 添加编辑状态类
                    progressContainer.classList.add('editing');
                    
                    // 创建输入框
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'progress-edit-input';
                    input.min = '0';
                    input.max = '100';
                    input.value = currentProgress;
                    
                    // 替换进度条内容为输入框
                    progressContainer.innerHTML = '';
                    progressContainer.appendChild(input);
                    
                    // 聚焦并选中文本
                    setTimeout(() => {
                        input.focus();
                        input.select();
                    }, 10);
                    
                    // 输入框失去焦点时保存
                    input.addEventListener('blur', function() {
                        saveProgressEdit(progressContainer, input);
                    });
                    
                    // 键盘事件
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveProgressEdit(progressContainer, input);
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelProgressEdit(progressContainer);
                        }
                    });
                }
            });
            
            // 保存进度编辑
            function saveProgressEdit(progressContainer, input) {
                let progress = parseInt(input.value) || 0;
                
                // 限制进度在0-100之间
                if (progress < 0) progress = 0;
                if (progress > 100) progress = 100;
                
                if (currentEditingIndex !== null) {
                    taskData[currentEditingIndex].progress = progress;
                    saveData();
                }
                
                // 恢复进度条显示
                restoreProgressDisplay(progressContainer, progress);
            }
            
            // 取消进度编辑
            function cancelProgressEdit(progressContainer) {
                progressContainer.innerHTML = originalProgressHTML;
                progressContainer.classList.remove('editing');
                currentEditingIndex = null;
                originalProgressHTML = '';
            }
            
            // 恢复进度条显示
            function restoreProgressDisplay(progressContainer, progress) {
                progressContainer.classList.remove('editing');
                progressContainer.innerHTML = `
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <span class="progress-text">${progress}%</span>
                `;
                currentEditingIndex = null;
                originalProgressHTML = '';
            }
            
            // 创建时间和计划完成时间
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('change', function() {
                    const taskIndex = parseInt(this.dataset.index);
                    
                    if (this.classList.contains('create-time')) {
                        taskData[taskIndex].createTime = this.value;
                    } else if (this.classList.contains('plan-finish-time')) {
                        taskData[taskIndex].planFinishTime = this.value;
                    }
                    
                    // 如果创建时间和计划完成时间都有，计算持续时间
                    if (taskData[taskIndex].createTime && taskData[taskIndex].planFinishTime) {
                        const createDate = new Date(taskData[taskIndex].createTime);
                        const finishDate = new Date(taskData[taskIndex].planFinishTime);
                        const duration = Math.ceil((finishDate - createDate) / (1000 * 60 * 60 * 24));
                        taskData[taskIndex].duration = duration > 0 ? duration : 0;
                        
                        // 更新显示
                        const row = this.closest('tr');
                        const durationCell = row.querySelector('td:last-child');
                        durationCell.textContent = taskData[taskIndex].duration;
                    }
                    
                    saveData();
                });
            });
        }

        // 添加展开/收起事件监听器
        function addExpandListeners() {
            document.querySelectorAll('.expandable-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    // 防止点击状态选择器、进度条等元素时触发展开/收起
                    if (e.target.closest('.status-selector') || 
                        e.target.closest('.progress-container') || 
                        e.target.closest('.time-input')) {
                        return;
                    }
                    
                    e.stopPropagation();
                    
                    const taskIndex = this.dataset.taskIndex;
                    const detailRow = document.querySelector(`tr.detail-row[data-task-index="${taskIndex}"]`);
                    const expandIcon = this.querySelector('.expand-icon');
                    
                    if (detailRow) {
                        const isExpanded = detailRow.style.display === 'table-row';
                        
                        if (isExpanded) {
                            // 收起
                            detailRow.style.display = 'none';
                            expandIcon.className = 'fas fa-chevron-right expand-icon';
                            this.classList.remove('expanded');
                        } else {
                            // 展开
                            detailRow.style.display = 'table-row';
                            expandIcon.className = 'fas fa-chevron-down expand-icon';
                            this.classList.add('expanded');
                        }
                    }
                });
            });
        }

        // 添加编辑功能事件监听器
        function addEditListeners() {
            document.querySelectorAll('.edit-icon').forEach(editIcon => {
                editIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const detailSection = this.closest('.detail-section');
                    const detailText = detailSection.querySelector('.detail-text');
                    const field = detailSection.dataset.field;
                    const taskIndex = parseInt(detailSection.dataset.taskIndex);
                    
                    // 如果已经在编辑模式，则不处理
                    if (detailSection.classList.contains('editing')) {
                        return;
                    }
                    
                    // 进入编辑模式
                    enterEditMode(detailSection, detailText, field, taskIndex);
                });
            });
        }

        // 进入编辑模式
        function enterEditMode(detailSection, detailText, field, taskIndex) {
            const currentText = detailText.textContent.trim();
            const originalText = currentText === '暂无内容' ? '' : currentText;
            
            // 标记为编辑状态
            detailSection.classList.add('editing');
            
            // 创建编辑界面
            const editContainer = document.createElement('div');
            editContainer.className = 'edit-container';
            
            editContainer.innerHTML = `
                <textarea class="edit-textarea" placeholder="请输入内容...">${originalText}</textarea>
                <div class="edit-buttons">
                    <button class="edit-btn save">保存</button>
                    <button class="edit-btn cancel">取消</button>
                </div>
            `;
            
            // 隐藏原始文本，显示编辑界面
            detailText.style.display = 'none';
            detailSection.querySelector('.edit-icon').style.display = 'none';
            detailSection.appendChild(editContainer);
            
            // 聚焦到文本框
            const textarea = editContainer.querySelector('.edit-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            
            // 添加按钮事件
            const saveBtn = editContainer.querySelector('.edit-btn.save');
            const cancelBtn = editContainer.querySelector('.edit-btn.cancel');
            
            saveBtn.addEventListener('click', () => {
                saveEdit(detailSection, detailText, field, taskIndex, textarea.value, editContainer);
            });
            
            cancelBtn.addEventListener('click', () => {
                cancelEdit(detailSection, detailText, editContainer);
            });
            
            // 按键事件
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    cancelEdit(detailSection, detailText, editContainer);
                } else if (e.key === 'Enter' && e.ctrlKey) {
                    saveEdit(detailSection, detailText, field, taskIndex, textarea.value, editContainer);
                }
            });
        }

        // 保存编辑
        function saveEdit(detailSection, detailText, field, taskIndex, newValue, editContainer) {
            // 更新数据
            if (field === 'note') {
                taskData[taskIndex].note = newValue;
            } else if (field === 'materials') {
                taskData[taskIndex].materials = newValue;
            }
            
            // 保存到本地存储
            localStorage.setItem('taskData', JSON.stringify(taskData));
            
            // 更新显示
            detailText.textContent = newValue || '';
            
            // 退出编辑模式
            exitEditMode(detailSection, detailText, editContainer);
        }

        // 取消编辑
        function cancelEdit(detailSection, detailText, editContainer) {
            exitEditMode(detailSection, detailText, editContainer);
        }

        // 退出编辑模式
        function exitEditMode(detailSection, detailText, editContainer) {
            // 移除编辑状态
            detailSection.classList.remove('editing');
            
            // 显示原始文本和编辑图标
            detailText.style.display = '';
            detailSection.querySelector('.edit-icon').style.display = '';
            
            // 移除编辑界面
            editContainer.remove();
        }

        // 添加任务详情编辑功能事件监听器
        function addTaskDetailEditListeners() {
            document.querySelectorAll('.task-detail-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // 如果已经在编辑模式，则不处理
                    if (this.classList.contains('editing')) {
                        return;
                    }
                    
                    const taskIndex = parseInt(this.dataset.taskIndex);
                    const currentText = this.textContent.trim();
                    
                    // 进入编辑模式
                    enterTaskDetailEditMode(this, taskIndex, currentText);
                });
            });
        }

        // 进入任务详情编辑模式
        function enterTaskDetailEditMode(cell, taskIndex, currentText) {
            // 标记为编辑状态
            cell.classList.add('editing');
            
            // 创建编辑界面
            const editContainer = document.createElement('div');
            editContainer.className = 'task-detail-edit-container';
            
            editContainer.innerHTML = `
                <input type="text" class="task-detail-input" value="${currentText}" placeholder="请输入任务详情...">
                <div class="task-detail-buttons">
                    <button class="task-detail-btn save">保存</button>
                    <button class="task-detail-btn cancel">取消</button>
                </div>
            `;
            
            // 替换原内容
            const originalContent = cell.innerHTML;
            cell.innerHTML = '';
            cell.appendChild(editContainer);
            
            // 聚焦到输入框
            const input = editContainer.querySelector('.task-detail-input');
            input.focus();
            input.select();
            
            // 添加按钮事件
            const saveBtn = editContainer.querySelector('.task-detail-btn.save');
            const cancelBtn = editContainer.querySelector('.task-detail-btn.cancel');
            
            saveBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                saveTaskDetailEdit(cell, taskIndex, input.value, originalContent);
            });
            
            cancelBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                cancelTaskDetailEdit(cell, originalContent);
            });
            
            // 键盘事件
            input.addEventListener('keydown', (e) => {
                e.stopPropagation();
                if (e.key === 'Enter') {
                    saveTaskDetailEdit(cell, taskIndex, input.value, originalContent);
                } else if (e.key === 'Escape') {
                    cancelTaskDetailEdit(cell, originalContent);
                }
            });
        }

        // 保存任务详情编辑
        function saveTaskDetailEdit(cell, taskIndex, newValue, originalContent) {
            // 更新数据
            taskData[taskIndex].taskDetail = newValue;
            
            // 保存到本地存储
            localStorage.setItem('razPrepData', JSON.stringify(taskData));
            
            // 更新显示
            cell.innerHTML = newValue || '暂无详情';
            cell.classList.remove('editing');
        }

        // 取消任务详情编辑
        function cancelTaskDetailEdit(cell, originalContent) {
            // 恢复原内容
            cell.innerHTML = originalContent;
            cell.classList.remove('editing');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            renderStageNav();
            renderTasksTable();
            updateStats();
        });
    </script>
</body>
</html>